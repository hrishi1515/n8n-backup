 {
  "createdAt": "2025-07-22T14:08:09.488Z",
  "updatedAt": "2025-07-22T14:08:09.000Z",
  "id": "4PTXxbHxcYO5B4qt",
  "name": "My workflow 32",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "id": "9aaf4050-487f-47b8-8c10-b41019980e51",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -740,
        360
      ],
      "credentials": {
        "openAiApi": {
          "id": "opkNg3RQ0U03w9cG",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Agent Tools for RAG",
        "height": 528.85546469693,
        "width": 583.4552380860637,
        "color": 4
      },
      "id": "4d66e17f-01c3-419e-be47-8deb49f8cbd1",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {},
      "id": "77a7f2de-2f9f-40af-ba2d-e4bd21876484",
      "name": "Postgres Chat Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1,
      "position": [
        -600,
        360
      ],
      "notesInFlow": false,
      "credentials": {
        "postgres": {
          "id": "OppxKTuR17k2wxru",
          "name": "Postgres account 7"
        }
      }
    },
    {
      "parameters": {
        "content": "## RAG AI Agent with Chat Interface",
        "height": 464.8027193303974,
        "width": 1035.6381264595484
      },
      "id": "98692728-a041-4b68-abcb-7fa7c14357a6",
      "name": "Sticky Note2",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1040,
        60
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "bbf3529f-2bea-459c-949d-ec13b1b4bbf7",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -200,
        40
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9a9a245e-f1a1-4282-bb02-a81ffe629f0f",
              "name": "chatInput",
              "value": "={{ $json?.chatInput || $json.body.chatInput }}",
              "type": "string"
            },
            {
              "id": "b80831d8-c653-4203-8706-adedfdb98f77",
              "name": "sessionId",
              "value": "={{ $json?.sessionId || $json.body.sessionId}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "fdbbe485-237a-4770-b4dd-87e316239564",
      "name": "Edit Fields",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -740,
        140
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.chatInput }}",
        "options": {
          "systemMessage": "=You are a specialized assistant for retrieving information about pumps from the company named  KBL. You help users find pumps based on their application, pricing, and specifications using both unstructured documents (TXT, DOCX, extracted PDFs) and structured tabular data (CSVs, Excel, JSONB in PostgreSQL).\n\nðŸ“Œ HR Policies Retrieval\n\nIf the user query is about any HR policy (e.g., leave policy, travel policy, reimbursement policy, work from home, PLIP, appraisal, dress code, etc.):\n\n- Immediately return the plain user query as the tool input.  \n- Do NOT wrap it in `{ \"query\": ... }`.  \n- Do NOT add any other keys or JSON structure.  \n- The output must be just the plain text:  Tell me about PLIP policy\n\n- This text will be passed directly to the Embeddings tool.\n\n- Then the Embeddings tool generates a vector, and the Supabase Vector Store will run the similarity match.\n\n- If no good answer is found, reply:  \n**\"I couldnâ€™t find this policy detail in our HR documents. Please check with HR or contact your manager for clarification.\"**\n\n\nSearch Strategy:\nUser Query Analysis\n\nIf a user asks for \"pumps\" or \"water pumps\" or \"another pumps\" without specifying the application, prompt them to clarify the intended use by suggesting options such as:\nGardening\nIrrigation\nResidential Pressure Boosting\nCommercial & Industrial Use\nDewatering\nFirefighting\nAgriculture\nor any other application of your use case\nOnce the user specifies the application, refine the search accordingly.\ncollect essential information before recommending a product.\nIf the user specifies an application (even if it's not in the predefined list), attempt to search for it dynamically:\nFirst, search in the structured table (document_rows) using SQL to find pumps where the row_data->>'categories' or row_data->>'description' contains the specified application.\nIf no results are found, attempt a RAG-based search on text-based documents.\nIf the query involves pricing, specifications, or comparisons, execute SQL queries to filter the pumps accordingly.\nInformation Retrieval Methods:\n\nGeneral Pump Information (Applications, Features, Descriptions): Use RAG (Retrieval-Augmented Generation) to extract relevant content from the documents table.\nSpecific Pump Details (Pricing, Filtering, Comparisons): Generate SQL queries using a specialized SQL-generation tool to search structured product data from the document_rows table.\nHybrid Search: Combine both approaches when necessary.\n\nSQL Query Generation for Structured Search:\nSQL Query Generation Rules:\nTable: document_rows\nProduct Data is stored in a JSONB field (row_data), so extract values like this:\nrow_data->>'name' â†’ Product name\nrow_data->>'price' â†’ Regular price\nrow_data->>'special_price' â†’ Discounted price\nrow_data->>'categories' â†’ Product categories or application\nrow_data->>'description' â†’ Detailed product overview and also contains application\nrow_data->>'url_key' â†’ Product URL key (for generating product links)\nUse ILIKE for searches to make them case-insensitive.\n\nUser Interaction Flow:\nWorkflow:\nAlways attempt RAG first, unless the query explicitly requires filtering by price, category, or application.\nIf RAG does not yield relevant results, check available documents in the document_metadata table to find the most relevant ones.\nFor tabular data, construct SQL queries to search the document_rows table, using JSONB field extraction.\nIf the user asks for a product by application, generate an SQL query that searches the \"categories\" and \"description\" fields in the row_data (JSONB) column of the document_rows table.\nIf the user asks for pricing-related queries (e.g., \"pumps under $5,000\"), filter results based on price.\nIf the user requests sorting (e.g., cheapest, most expensive), adjust the query accordingly.\n\nTo truly find products closest to a given target price, if user asks to find pump price around 30000\nuse ORDER BY absolute difference, like this:\nSELECT row_data->>'name' AS name,\n       row_data->>'price' AS price,\n       row_data->>'categories' AS application,\n       row_data->>'url_key' AS url_key\nFROM document_rows\nORDER BY ABS((row_data->>'price')::numeric - 30000)\nLIMIT 3;\nReturn only the first 3 matching pumps.\n\nðŸ“Œ Horsepower, Voltage, Phase, and Size Filtering\n\n- If the user asks for a pump with:\n  - a **specific horsepower** (e.g. â€œ3 HPâ€),\n  - a **specific voltage** (e.g. â€œ415 Voltsâ€),\n  - a **specific phase** (e.g. â€œSingle Phaseâ€, â€œ3 Phaseâ€, â€œThree Phaseâ€),\n  - or a **specific size** (e.g. â€œ25 mmâ€, â€œ100mm X 100mmâ€),\n\nâœ… The SQL query MUST search for these details inside BOTH the `name` field AND the `description` field.\n\nâœ… For each filter:\n- Use an OR condition for each field:\n  - Example for horsepower:  \n    `(row_data->>'name' ILIKE '%3 HP%' OR row_data->>'description' ILIKE '%3 HP%')`\n  - Example for voltage:  \n    `(row_data->>'name' ILIKE '%415 Volts%' OR row_data->>'description' ILIKE '%415 Volts%')`\n  - Example for phase:  \n    `(row_data->>'name' ILIKE '%Single Phase%' OR row_data->>'description' ILIKE '%Single Phase%')`\n  - Example for size:  \n    `(row_data->>'name' ILIKE '%25 mm%' OR row_data->>'description' ILIKE '%25 mm%')`\n\nâœ… Combine multiple filters with **AND**:\n- If the user specifies more than one (e.g. â€œ2 HPâ€, â€œSingle Phaseâ€, â€œ210 Voltsâ€), combine all in the WHERE clause.\n\nIf the user asks for a specific horsepower like â€œ5 HPâ€, use a regex WHERE condition with word boundaries to avoid matching â€œ1.5 HPâ€, â€œ0.5 HPâ€, etc.\nUse:\nWHERE row_data->>'name' ~* '(^|[ ,\\-])5 HP($|[^0-9])'\n\n\nâœ… This guarantees exact matches only.\n\nFallback:\nIf no rows are returned from the SQL query:\n- Immediately pass the same user query to the HTTP Request node.\n- The HTTP Request node will call the RAG-based API (`/chat/stream`) to find possible answers from unstructured documents.\n- Return the result from the HTTP Request node to the user.\n- If the fallback still finds no relevant data, clearly inform the user and offer human support if needed.\n\n\nResponse Format:\nIf using RAG, provide pump details in a structured way.\nIf using SQL, return a concise list of the top 3 pumps\n\nPresent each product like this:\n**{Product Name}**  \nðŸ’° **Price**: â‚¹{price}  \nðŸ”§ **Application**: {one-line summary or description}  \nðŸ”— **Product Link**: [View Product](url_key)\n\n\nFormula:\nlink =  url_key \nTransparency: If no relevant results are found, inform the user instead of making assumptions.\nHandling Unanswered or Non-Pump Queries:\nIf a user asks for human support or query is not related to pumps or no relevant data is found, provide the contact details and toll-free number.\nðŸ“ž Toll-Free Number: 1800-123-4443\nðŸ¢ Office Address:\nKirloskar Brothers Limited\nYamuna, S.No.98(3 to 7), Plot No.3,\nBaner, Pune 411045, Maharashtra, INDIA\nðŸ”— Visit our website: https://www.kirloskarpumps.com\n\n"
        }
      },
      "id": "5fb031d3-df6c-4d88-9aa9-b462f3b29ae3",
      "name": "RAG AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        -520,
        140
      ]
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Use this tool to fetch all available documents, including the table schema if the file is a CSV or Excel file.",
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -480,
        400
      ],
      "id": "4b84b7c0-b372-4339-aa92-324e3022ea6f",
      "name": "List Documents",
      "credentials": {
        "postgres": {
          "id": "OppxKTuR17k2wxru",
          "name": "Postgres account 7"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Given a file ID, fetches the text from the document.",
        "operation": "executeQuery",
        "query": "SELECT \n    string_agg(content, ' ') as document_text\nFROM documents\n  WHERE metadata->>'file_id' = $1\nGROUP BY metadata->>'file_id';",
        "options": {
          "queryReplacement": "={{ $fromAI('file_id') }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -380,
        360
      ],
      "id": "b1178cef-e4a0-455b-b9bd-29572fa677a8",
      "name": "Get File Contents",
      "credentials": {
        "postgres": {
          "id": "OppxKTuR17k2wxru",
          "name": "Postgres account 7"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "You are an AI assistant that generates SQL queries to search a PostgreSQL database storing product information in a JSONB field (row_data). The table structure is as follows:\nTable: document_rows\nPrimary Key: dataset_id (File ID)\nProduct Data: Stored in row_data (JSONB)\nImportant Product Fields:\nname â†’ Product name\nprice â†’ Regular price\nspecial_price â†’ Discounted price\ndescription â†’ Detailed product overview\ncategories â†’ Product categories\nQuery Logic:\nIf the user asks for products by category, use case, or application (e.g., \"I need a pump for gardening, commercial, or irrigation purposes\"), generate a query that searches both description and categories for relevant keywords.\nIf the user asks for price-related queries (e.g., \"Show me products under $10,000\"), filter based on price.\n\nIf the user asks for a specific product by SKU or name, return exact matches.\nIf the user requests sorting (e.g., cheapest, most expensive,etc), modify the query accordingly.\nfind out only the first 7 or top 7 pumps",
        "operation": "executeQuery",
        "query": "{{ $fromAI('sql_query') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -240,
        360
      ],
      "id": "ff796caf-15d7-4085-8cba-7d59eebf8bbe",
      "name": "Query Document Rows",
      "credentials": {
        "postgres": {
          "id": "OppxKTuR17k2wxru",
          "name": "Postgres account 7"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "documents",
        "toolDescription": "=Use RAG to look up information in the knowledgebase.\nif you do not receive any input query  use  {{ $('When chat message received').item.json.chatInput }}",
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "topK": 10,
        "options": {
          "queryName": "match_documents"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        0,
        120
      ],
      "id": "19941715-8a2a-4355-bd1e-35ac01b67be8",
      "name": "Supabase Vector Store1",
      "alwaysOutputData": true,
      "executeOnce": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "XtR98lBtev9Z8OTI",
          "name": "Supabase account 3"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        260,
        320
      ],
      "id": "18bfebf7-57f9-4f08-9146-330cb8b8a9df",
      "name": "Embeddings OpenAI2",
      "credentials": {
        "openAiApi": {
          "id": "opkNg3RQ0U03w9cG",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "public": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -960,
        140
      ],
      "id": "9745ba34-6fe0-4f8a-9792-6546c4a81dc5",
      "name": "When chat message received",
      "webhookId": "692f09b0-6b54-4543-9020-d694f7fe7374"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://35.209.52.119:8059/chat/stream",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters0_Value', ``, 'string') }}"
            },
            {
              "name": "user_id",
              "value": "web_user"
            },
            {
              "name": "search_type",
              "value": "hybrid"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        420,
        620
      ],
      "id": "ba07f4eb-0572-4f2e-ba4c-9501056624d7",
      "name": "HTTP Request",
      "disabled": true
    },
    {
      "parameters": {
        "toolDescription": "Makes an HTTP request and returns the response data.\ncompulsarily run this node when query document row node dont find any product .",
        "method": "POST",
        "url": "http://35.209.52.119:8059/chat",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters0_Value', ``, 'string') }}"
            },
            {
              "name": "session_id",
              "value": "543ab237-08ae-4fc9-bf6c-8930cf766352"
            },
            {
              "name": "user_id",
              "value": "web_user"
            },
            {
              "name": "search_type",
              "value": "hybrid"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        -80,
        360
      ],
      "id": "2eb56032-1e4c-4621-bf27-6247d878171b",
      "name": "HTTP Request1"
    }
  ],
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "RAG AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RAG AI Agent": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List Documents": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get File Contents": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Query Document Rows": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store1": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI2": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "0c49b80a-25ca-4c0c-8d2d-79792c3c288d",
  "triggerCount": 0,
  "shared": [
    {
      "createdAt": "2025-07-22T14:08:09.492Z",
      "updatedAt": "2025-07-22T14:08:09.492Z",
      "role": "workflow:owner",
      "workflowId": "4PTXxbHxcYO5B4qt",
      "projectId": "dG371lM6unPJd2qz"
    }
  ],
  "tags": []
}